// license-header java merge-point
//
// Attention: Generated code! Do not modify by hand!
// Generated by SpringWSImpl.java.vsl in andromda-webservices.
//
package bw.co.centralkyc.document;

import org.springframework.http.ResponseEntity;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.io.InputStream;
import java.time.LocalDateTime;
import java.util.Collection;
import java.util.HashMap;
import java.util.Map;
import java.util.Optional;

import org.springframework.core.io.InputStreamResource;
import org.springframework.data.domain.Page;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;

import bw.co.centralkyc.AuditTracker;
import bw.co.centralkyc.TargetEntity;
import bw.co.centralkyc.minio.MinioService;

@RestController
public class DocumentApiImpl implements DocumentApi {

    private final MinioService minioService;
    private final DocumentService documentService;

    public DocumentApiImpl(DocumentService documentService, MinioService minioService) {

        this.documentService = documentService;
        this.minioService = minioService;
    }

    @Override
    public ResponseEntity<Collection<DocumentDTO>> findByDocumentType(String documentTypeId) {

        try {

            return ResponseEntity.ok(documentService.findByDocumentType(documentTypeId));

        } catch (Exception e) {

            throw e;
        }

    }

    @Override
    public ResponseEntity<DocumentDTO> findById(String id) {

        try {

            return ResponseEntity.ok(documentService.findById(id));

        } catch (Exception e) {

            throw e;
        }
    }

    @Override
    public ResponseEntity<Collection<DocumentDTO>> findByTarget(
            bw.co.centralkyc.TargetEntity target, String targetId) {

        try {

            return ResponseEntity.ok(documentService.findByTarget(target, targetId));
        } catch (Exception e) {

            throw e;
        }
    }

    @Override
    public ResponseEntity<Collection<DocumentDTO>> getAll() {
        return ResponseEntity.ok(documentService.getAll());

    }

    @Override
    public ResponseEntity<Page<DocumentDTO>> getAllPaged(Integer pageNumber, Integer pageSize) {

        try {

            return ResponseEntity.ok(documentService.getAll(pageNumber, pageSize));

        } catch (Exception e) {

            throw e;
        }

    }

    @Override
    public ResponseEntity<Boolean> remove(String id) {

        try {

            return ResponseEntity.ok(documentService.remove(id));

        } catch (Exception e) {

            throw e;
        }

    }

    @Override
    public ResponseEntity<DocumentDTO> save(DocumentDTO document) {

        try {

            Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
            AuditTracker.auditTrail(document, authentication);
            return ResponseEntity.ok(documentService.save(document));

        } catch (Exception e) {

            throw e;
        }

    }

    @Override
    public ResponseEntity<Collection<DocumentDTO>> search(String criteria) {

        try {

            return ResponseEntity.ok(documentService.search(criteria));
        } catch (Exception e) {

            throw e;
        }

    }

    private String constructFilePath(TargetEntity target, String targetId, String fileName) {
        StringBuilder filePath = new StringBuilder();
        filePath.append(target).append(targetId).append("/").append(fileName);

        return fileName;
    }

    private String uploadToMinio(MultipartFile file, String fileName) throws Exception {
        // Upload the file to MinIO
        try (InputStream inputStream = file.getInputStream()) {

            String url = minioService.uploadFile(fileName, inputStream, file.getSize(), file.getContentType());
            System.out.println("File uploaded to MinIO: " + url);
            return url;

        } catch (IOException e) {
            e.printStackTrace();
            throw new DocumentServiceException("Error uploading file: " + file.getOriginalFilename());
        }
    }

    // private InputStreamResource downloadFromMinio(String objectName) throws Exception {
    //     // Download the file from MinIO
    //     try (InputStream inputStream = minioService.downloadFile(objectName)) {
    //         // Process the input stream as needed
    //         System.out.println("File downloaded from MinIO: " + objectName);
    //         InputStreamResource resource = new InputStreamResource(inputStream);
    //         // byte[] fileBytes = inputStream.readAllBytes();
    //         inputStream.close();
    //         return resource;

    //     } catch (IOException e) {
    //         e.printStackTrace();
    //         throw new DocumentServiceException("Error downloading file: " + objectName);
    //     }
    // }

    @Override
    public ResponseEntity<DocumentDTO> upload(TargetEntity target, String targetId,
            String documentTypeId, MultipartFile file) {

        try {

            // Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
            // System.out.println(authentication);
            // Jwt jwt = (Jwt) authentication.getPrincipal();

            // System.out.println(jwt.getClaims());

            // String username = jwt.getClaimAsString("preferred_username");

            // DocumentDTO document = new DocumentDTO();
            // document.setCreatedAt(LocalDateTime.now());
            // document.setCreatedBy(username);
            // document.setTarget(target);
            // document.setTargetId(targetId);
            // document.setFileName(file.getOriginalFilename());

            // Map<String, Object> metadata = new HashMap<>();
            // metadata.put("fileSize", file.getSize());
            // metadata.put("fileType", file.getContentType());
            // metadata.put("contentType", file.getContentType());

            // document.setMetadata(metadata);

            // String filePath = constructFilePath(target, targetId, file.getOriginalFilename());
            // try {
            //     document.setUrl(uploadToMinio(file, filePath));
            // } catch (Exception e) {
            //     // TODO Auto-generated catch block
            //     e.printStackTrace();
            //     throw new DocumentServiceException("Error uploading file: " + file.getOriginalFilename());
            // }

            // document.setDocumentTypeId(documentTypeId);

            // return ResponseEntity.ok(documentService.save(document)); 

            return ResponseEntity.ok(documentService.save(null)); 

        } catch (Exception e) {

            throw e;
        }

    }
    
    private InputStreamResource downloadFromMinio(String url) throws Exception {

        // Download the file from MinIO
        InputStream inputStream = minioService.downloadFile(url);
        // Process the input stream as needed
        System.out.println("File downloaded from MinIO: " + url);
        InputStreamResource resource = new InputStreamResource(inputStream);
        return resource;
    }

    @Override
    public ResponseEntity<InputStreamResource> downloadFile(String id) {
        try {

            DocumentDTO document = documentService.findById(id);
            InputStreamResource data = downloadFromMinio(document.getUrl());
            ResponseEntity<InputStreamResource> response = ResponseEntity.status(HttpStatus.OK)
                    .header(HttpHeaders.CONTENT_DISPOSITION, "attachment; filename=\"" + document.getUrl() + "\"")
                    .contentType(MediaType.APPLICATION_OCTET_STREAM)
                    .body(data);

            return response;

        } catch (Exception e) {
            e.printStackTrace();
            throw new DocumentServiceException("Error downloading file: " + e.getMessage());
        }
    }

    public ResponseEntity<InputStreamResource> downloadFileByUrl(@RequestParam String objectName) throws Exception {

        InputStreamResource data = downloadFromMinio(objectName);
        ResponseEntity<InputStreamResource> response = ResponseEntity.status(HttpStatus.OK)
                .header(HttpHeaders.CONTENT_DISPOSITION, "attachment; filename=\"" + objectName + "\"")
                .contentType(MediaType.APPLICATION_OCTET_STREAM)
                .body(data);

        return response;

    }
}