// license-header java merge-point
//
// Attention: Generated code! Do not modify by hand!
// Generated by SpringWSImpl.java.vsl in andromda-webservices.
//
package bw.co.centralkyc.individual;

import org.springframework.http.ResponseEntity;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.bind.annotation.RestController;

import java.security.SecureRandom;
import java.util.Collection;
import java.util.List;
import java.util.Set;

import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.data.domain.Page;

import bw.co.centralkyc.AuditTracker;
import bw.co.centralkyc.PropertySearchOrder;
import bw.co.centralkyc.SearchObject;
import bw.co.centralkyc.email.EmailService;
import bw.co.centralkyc.keycloak.KeycloakOrganisationService;
import bw.co.centralkyc.keycloak.KeycloakUserService;
import bw.co.centralkyc.organisation.OrganisationDTO;
import bw.co.centralkyc.organisation.OrganisationListDTO;
import bw.co.centralkyc.organisation.branch.BranchDTO;
import bw.co.centralkyc.organisation.branch.BranchService;
import bw.co.centralkyc.user.UserDTO;
import bw.co.roguesystems.comm.ContentType;
import bw.co.roguesystems.comm.MessagingPlatform;
import bw.co.roguesystems.comm.message.CommMessageDTO;

@RestController
public class IndividualApiImpl implements IndividualApi {

    @Value("${app.organisation.manager-role}")
    private String organisationManagerRole;

    @Value("${app.security.password.min-length}")
    private int minPasswordLength;

    @Value("${app.admin-web}")
    private String adminWebUrl;

    @Value("${app.comm.source-email}")
    private String sourceEmail;

    private final KeycloakUserService keycloakUserService;
    private final KeycloakOrganisationService keycloakOrgService;
    private final BranchService branchService;
    private final EmailService emailService;
    private final IndividualService individualService;

    private static final SecureRandom RANDOM = new SecureRandom();

    private static final String UPPER = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    private static final String LOWER = "abcdefghijklmnopqrstuvwxyz";
    private static final String DIGITS = "0123456789";
    private static final String SYMBOLS = "@#$%!";

    private static final String newUserTemplate = """
            Dear %s,

            Welcome to Central KYC platform. Your organisation, %s, has selected you to manage
            their account. This message alerts you that a user has been created for you on the
            platform. Please find the login details below:

            URL: %s
            Username: %s
            Password: %s

            Regards

            CentralKYC Team
            """;

    public IndividualApiImpl(IndividualService individualService, KeycloakUserService keycloakUserService,
            BranchService branchService, EmailService emailService, KeycloakOrganisationService keycloakOrgService) {

        this.individualService = individualService;
        this.keycloakUserService = keycloakUserService;
        this.branchService = branchService;
        this.emailService = emailService;
        this.keycloakOrgService = keycloakOrgService;
    }

    @Override
    public ResponseEntity<IndividualDTO> findById(String id) {

        try {

            IndividualDTO data = individualService.findById(id);

            if (data.getHasUser()) {

                if(data.getOrganisation() != null && StringUtils.isNotBlank(data.getOrganisation().getId())) {

                    OrganisationDTO org = keycloakOrgService.findById(data.getOrganisation().getId());
                    OrganisationListDTO o = new OrganisationListDTO();
                    o.setId(org.getId());
                    o.setCode(org.getCode());
                    o.setContactEmailAddress(org.getContactEmailAddress());
                    o.setName(org.getName());
                    o.setRegistrationNo(org.getRegistrationNo());
                    o.setStatus(org.getStatus());

                    data.setOrganisation(o);
                }

            }

            return ResponseEntity.ok(data);
        } catch (Exception e) {
            throw e;
        }

    }

    @Override
    public ResponseEntity<Collection<IndividualListDTO>> getAll() {

        try {

            return ResponseEntity.ok(individualService.getAll());
        } catch (Exception e) {
            throw e;
        }
    }

    @Override
    public ResponseEntity<Page<IndividualListDTO>> getAllPaged(Integer pageNumber,
            Integer pageSize) {

        try {
            return ResponseEntity.ok(individualService.getAll(pageNumber, pageSize));

        } catch (Exception e) {
            throw e;
        }
    }

    @Override
    public ResponseEntity<Page<IndividualListDTO>> pagedSearch(
            SearchObject<IndividualSearchCriteria> criteria) {

        try {

            return ResponseEntity.ok(individualService.search(criteria));

        } catch (Exception e) {
            throw e;
        }
    }

    @Override
    public ResponseEntity<Boolean> remove(String id) {

        try {

            return ResponseEntity.ok(individualService.remove(id));

        } catch (Exception e) {
            throw e;
        }

    }


    private CommMessageDTO newUserMessage(IndividualDTO individual, UserDTO user) {

        // OrganisationDTO org = keycloakOrgService.

        CommMessageDTO message = new CommMessageDTO();

        message.setContentType(ContentType.PLAIN_TEXT);
        message.setDestinations(List.of(individual.getEmailAddress()));
        message.setSource(sourceEmail);

        StringBuilder nameBuilder = new StringBuilder();
        nameBuilder.append(individual.getFirstName()).append(' ');
        if (StringUtils.isNotBlank(individual.getMiddleName())) {

            nameBuilder.append(individual.getMiddleName()).append(' ');
        }

        nameBuilder.append(individual.getSurname());

        String messageStr = String.format(newUserTemplate, nameBuilder.toString(), individual.getOrganisation(),
                adminWebUrl, user.getUsername(),
                user.getPassword());

        message.setText(messageStr);
        message.setPlatform(MessagingPlatform.EMAIL);

        OrganisationDTO org = keycloakOrgService.findById(individual.getOrganisation().getId());

        if(org != null) {

            if(StringUtils.isNotBlank(org.getContactEmailAddress())) {
                message.setCcs(List.of(org.getContactEmailAddress()));
            }
            
        }

        return message;

    }

    @Override
    public ResponseEntity<IndividualDTO> save(IndividualDTO individual) {

        try {

            Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
            AuditTracker.auditTrail(individual, authentication);

            UserDTO user = keycloakUserService.getUserByIdentityNo(individual.getIdentityNo());
            boolean isNewUser = false;

            if (user == null) {

                UserDTO existing = keycloakUserService.getUserByEmail(individual.getEmailAddress());

                boolean createUser = isNewUser = (existing == null) && (individual.getHasUser() != null && individual.getHasUser());

                if (createUser) {

                    if (existing != null) {
                        boolean sameUser = existing.getFirstName().equals(individual.getFirstName())
                                && existing.getUsername().equals(individual.getSurname());

                        if (!sameUser) {

                            throw new IndividualServiceException(
                                    "The provided individual has an email used by a user who does not match the given information.");
                        }
                    }

                    keycloakUserService.registerUser(individual);
                }

            }

            individual = individualService.save(individual);
            if (isNewUser) {
                try {
                    emailService.sendEmail(List.of(newUserMessage(individual, user)));
                } catch (Exception e) {
                    // Log and continue
                    System.err.println("Failed to send new user email: " + e.getMessage());
                    throw new IndividualServiceException(
                            "Individual saved but failed to send new user email notification.", e);
                }

            }

            return ResponseEntity.ok(individual);

        } catch (Exception e) {
            throw e;
        }
    }

    @Override
    public ResponseEntity<Collection<IndividualListDTO>> search(
            SearchObject<IndividualSearchCriteria> criteria) {

        try {

            Set<PropertySearchOrder> sortings = new java.util.HashSet<>();

            if(criteria.getSortings() != null) {

                sortings.addAll(criteria.getSortings());
            }

            return ResponseEntity
                    .ok(individualService.search(criteria.getCriteria(), sortings));

        } catch (Exception e) {
            throw e;
        }

    }

    @Override
    public ResponseEntity<Collection<IndividualListDTO>> getOrganisationClients(
            String organisationId) throws Exception {

        try {

            return ResponseEntity
                    .ok(null);

        } catch (Exception e) {
            throw e;
        }
    }

    @Override
    public ResponseEntity<Page<IndividualListDTO>> getOrganisationClientsPaged(
            String criteria, Integer pageNumber, Integer pageSize) throws Exception {

        try {

            return ResponseEntity
                    .ok(null);

        } catch (Exception e) {
            throw e;
        }
    }

    @Override
    public ResponseEntity<IndividualDTO> loadRequestIndividual(String requestId, String identityConfirmationToken,
            String identityNo) throws Exception {
        
        try {
            IndividualDTO individual = individualService.loadRequestIndividual(requestId, identityConfirmationToken,
                    identityNo);

            return ResponseEntity.ok(individual);

        } catch (Exception e) {
            throw e;
        }
    }
}