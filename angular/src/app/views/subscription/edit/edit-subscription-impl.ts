// Generated by andromda-angular cartridge (view\view.component.imp.ts.vsl) CAN EDIT!
import { Component, effect, inject, Input, linkedSignal } from '@angular/core';
import { EditSubscriptionComponent } from '@views/subscription/edit/edit-subscription';
import { CommonModule } from '@angular/common';
import { FormsModule, ReactiveFormsModule } from '@angular/forms';
import { TranslateModule } from '@ngx-translate/core';
import { MaterialModule } from '@app/material.module';
import { Loader } from "@shared/loader/loader";
import { Field } from '@angular/forms/signals';
import { OrganisationApiStore } from '@app/store/bw/co/centralkyc/organisation/organisation-api.store';
import { SearchObject } from '@app/models/search-object';
import { OrganisationSearchCriteria } from '@app/models/bw/co/centralkyc/organisation/organisation-search-criteria';
import { OrganisationListDTO } from '@app/models/bw/co/centralkyc/organisation/organisation-list-dto';
import { KycSubscriptionDTO } from '@app/models/bw/co/centralkyc/subscription/kyc-subscription-dto';

@Component({
  selector: 'app-edit-subscription',
  templateUrl: './edit-subscription.html',
  styleUrls: ['./edit-subscription.scss'],
  standalone: true,
  imports: [
    CommonModule,
    TranslateModule,
    MaterialModule,
    Loader,
    Field,
  ],
})
export class EditSubscriptionImplComponent extends EditSubscriptionComponent {
  organisationApiStore = inject(OrganisationApiStore);

  @Input() id: string | any;

  override loading = linkedSignal(() => this.kycSubscriptionApiStore.loading());
  override error = linkedSignal(() => this.kycSubscriptionApiStore.error());
  override messages = linkedSignal(() => this.kycSubscriptionApiStore.messages());
  override success = linkedSignal(() => this.kycSubscriptionApiStore.success());

  override organisationDisplays: string[] = ['name'];

  constructor() {
    super();

    this.kycSubscriptionApiStore.reset();
    if (this.id) {
      this.kycSubscriptionApiStore.findById({ id: this.id });
    }

    effect(() => {
      const organisations = this.organisationApiStore.dataList();
      this.organisationFilteredList.set(organisations);
    });

    effect(() => {
      let subscription = this.kycSubscriptionApiStore.data();
      if (subscription) {

        this.editSubscriptionSignal.update((form) => ({
            id: subscription.id,
            createdAt: subscription.createdAt,
            createdBy: subscription.createdBy,
            modifiedAt: subscription.modifiedAt,
            modifiedBy: subscription.modifiedBy,
            organisation: subscription.organisationId ? {
              id: subscription.organisationId,
              name: subscription.organisationName,
              code: subscription.organisationCode,
              registrationNo: subscription.organisationRegistrationNo,
              status: '',
              contactEmailAddress: ''
            } : null,
            ref: subscription.ref,
            startDate: subscription.startDate,
            endDate: subscription.endDate,
            amount: subscription.amount,
            status: subscription.status,
            period: subscription.period,
            organisationFilter: ''
        }));

    this.organisationFilteredList.set([{
      id: subscription.organisationId,
      name: subscription.organisationName,
      code: subscription.organisationCode,
      registrationNo: subscription.organisationRegistrationNo,
      status: '',
      contactEmailAddress: '',
      isClient: false,
      kycStatus: ''
    }]);
  }
});
  }

  override ngOnInit() {

  this.route.queryParams.subscribe((params) => {
    const id = params['id'];
    if (id) {
      this.kycSubscriptionApiStore.findById({ id: id });
      let search = new SearchObject<OrganisationSearchCriteria>();
      search.criteria = {
        id: id,
      };

      this.organisationApiStore.search({
        criteria: search,
      });
    }
  });

}

doNgOnDestroy(): void {}

  override beforeEditSubscriptionSave(form: any): void {
  let formValue = this.editSubscriptionSignal();

  let subscription = new KycSubscriptionDTO();
  subscription.id = formValue.id;
  subscription.ref = formValue.ref;
  subscription.organisationName = formValue.organisation?.name;
  subscription.organisationId = formValue.organisation?.id;
  subscription.organisationCode = formValue.organisation?.code;
  subscription.organisationRegistrationNo = formValue.organisation?.registrationNo;
  subscription.status = formValue.status;
  subscription.startDate = formValue.startDate;
  subscription.endDate = formValue.endDate;
  subscription.amount = formValue.amount;
  subscription.period = formValue.period;
  subscription.createdBy = formValue.createdBy;
  subscription.createdAt = formValue.createdAt;
  subscription.modifiedBy = formValue.modifiedBy;
  subscription.modifiedAt = formValue.modifiedAt;

  this.kycSubscriptionApiStore.save({ subscription });
}

  override organisationCompare(o1: OrganisationListDTO | any, o2: OrganisationListDTO | any) {
  return o1 && o2 ? o1.id === o2.id : o1 === o2;
}

  override filterOrganisation() {
  const filterValue = this.editSubscriptionSignal().organisationFilter || '';
  let search = new SearchObject<OrganisationSearchCriteria>();
  search.criteria = {
    name: filterValue,
  };

  this.organisationApiStore.search({
    criteria: search,
  });
}
}
