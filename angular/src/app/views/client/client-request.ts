import { Loader } from '@shared/loader/loader';
// Generated by andromda-angular cartridge (usecase\use-case.ts.vsl) DO NOT EDIT
import {
  OnInit,
  inject,
  Component,
  AfterViewInit,
  signal,
  Signal,
  ViewChild,
  effect,
  OnDestroy,
  linkedSignal,
} from '@angular/core';
import {
  FormField,
  form,
} from "@angular/forms/signals";
import { ActivatedRoute, Router, RouterLink, RouterModule } from '@angular/router';
import { CommonModule } from '@angular/common';
import { MatDialog } from '@angular/material/dialog';
import { ClientRequestControllerImpl } from '@controllers/client/client-request-controller-impl';
import { UseCaseScope } from '@app/utils/use-case-scope';
import { ClientRequestApi } from '@services/bw/co/centralkyc/organisation/client/client-request-api';
import { ClientRequestApiStore } from '@store/bw/co/centralkyc/organisation/client/client-request-api.store';
import { ClientRequestSearchCriteria } from '@models/bw/co/centralkyc/organisation/client/client-request-search-criteria';
import { ClientRequestDTO } from '@models/bw/co/centralkyc/organisation/client/client-request-dto';
import { ClientRequestStatus } from '@models/bw/co/centralkyc/organisation/client/client-request-status';
import { TargetEntity } from '@models/bw/co/centralkyc/target-entity';
import { OrganisationListDTO } from '@models/bw/co/centralkyc/organisation/organisation-list-dto';
import { IndividualListDTO } from '@models/bw/co/centralkyc/individual/individual-list-dto';
import { TableComponent } from '@components/table/table';
import { ColumnModel } from '@models/column.model';
import { ActionTemplate } from '@models/action-template';
import { Page } from '@app/models/page.model';
import { ToastrService } from 'ngx-toastr';
import { TranslateModule } from '@ngx-translate/core';
import { MaterialModule } from '@app/material.module';
import { SearchObject } from '@app/models/search-object';
import { OrganisationApiStore } from '@app/store/bw/co/centralkyc/organisation/organisation-api.store';
import { OrganisationSearchCriteria } from '@app/models/bw/co/centralkyc/organisation/organisation-search-criteria';
import { OrganisationApi } from '@app/services/bw/co/centralkyc/organisation/organisation-api';
import { IndividualApiStore } from '@app/store/bw/co/centralkyc/individual/individual-api.store';
import { IndividualSearchCriteria } from '@app/models/bw/co/centralkyc/individual/individual-search-criteria';

export class ClientRequestSearchForm {
  name: string | any = null;
  emailAddress: string | any = null;
  organisation: OrganisationListDTO | any = null;
  organisationFilter: OrganisationListDTO | any = null;
  status: ClientRequestStatus | any = null;
  target: TargetEntity | any = null;
  targetId: OrganisationListDTO | IndividualListDTO | any = null;
  targetIdFilter: string | any = null;
  clientRequests: Array<ClientRequestDTO> = [];
}

@Component({
  selector: 'app-client-request',
  templateUrl: './client-request.html',
  styleUrls: ['./client-request.scss'],
  standalone: true,
  imports: [
    CommonModule,
    MaterialModule,
    TranslateModule,
    TableComponent,
    Loader,
    FormField,
    RouterModule
],
})
export class ClientRequestComponent implements OnInit, AfterViewInit, OnDestroy {

  protected route: ActivatedRoute = inject(ActivatedRoute);
  individualApiStore = inject(IndividualApiStore);
  organisationApiStore = inject(OrganisationApiStore);
  organisationApi = inject(OrganisationApi);
  protected router: Router = inject(Router);
  protected useCaseScope: UseCaseScope = inject(UseCaseScope);
  dialog: MatDialog = inject(MatDialog);
  toaster: ToastrService = inject(ToastrService);
  clientRequestController: ClientRequestControllerImpl = inject(ClientRequestControllerImpl);
  readonly clientRequestApi = inject(ClientRequestApi);
  readonly clientRequestApiStore = inject(ClientRequestApiStore);

  clientRequestVarsForm: ClientRequestSearchForm = new ClientRequestSearchForm();
  clientRequestSignal = signal(this.clientRequestVarsForm);
  clientRequestSignalForm = form(this.clientRequestSignal, (path) => {
  });

  @ViewChild('clientRequestsTable') clientRequestsTable!: TableComponent<Array<ClientRequestDTO>>;
  clientRequestsTableSignal = linkedSignal<Page<ClientRequestDTO>>(() => {
    return this.clientRequestApiStore.dataPage();
  });
  clientRequestsTablePaged: boolean = true;

  clientRequestsTableColumns: ColumnModel[] = [
    new ColumnModel(
      'registration',
      'registration',
      false,
    ),
    new ColumnModel(
      'name',
      'name',
      false,
    ),
    new ColumnModel(
      'emailAddress',
      'email.address',
      false,
    ),
    new ColumnModel(
      'organisation',
      'organisation',
      false,
    ),
    new ColumnModel(
      'status',
      'status',
      false,
    ),
    new ColumnModel(
      'target',
      'target',
      false,
    ),
  ];

  clientRequestsTableColumnsActions: ActionTemplate[] = [
    {
      id: 'client-request-edit',
      label: 'edit',
      icon: 'edit',
      tooltip: 'edit',
    },
    // {
    //   id: 'client-request-details',
    //   label: 'details',
    //   icon: 'remove_red_eye',
    //   tooltip: 'details',
    // },
  ];

  showClientRequestsActions = true;

  clientRequestsTableActionClicked(event: any): void {

    switch (event.action) {
      case 'client-request-edit':

        this.router.navigate(["/client-request", "edit", event.row.id],);

        break;
      case 'client-request-details':
        // this.router.navigate(["/client-request", "details"], {
        //   queryParams: { id: event.row.id }
        // });
        break;
    }
  }

  doClientRequestEdit(form: any): any { }
  doClientRequestDetails(form: any): any { }

  organisationCompare(o1: OrganisationListDTO | any, o2: OrganisationListDTO | any) {
    return o1 && o2 ? o1.id === o2.id : o1 === o2;
  }

  filterOrganisation() {

    let criteria = new SearchObject<OrganisationSearchCriteria>();
    criteria.criteria = {
      name: this.clientRequestSignal().organisationFilter || ''
    }
    this.organisationApiStore.search({ criteria: criteria });
  }

  organisationBackingList: OrganisationListDTO[] = [];
  organisationFilteredList = linkedSignal<OrganisationListDTO[]>(() => this.organisationApiStore.dataList());

  organisationDisplays: string[] = [
    'id',
    'code',
    'name',
    'registrationNo',
    'status',
    'contactEmailAddress',
  ];

  targetOrganisationCompare(o1: OrganisationListDTO | any, o2: OrganisationListDTO | any) {
    return o1 && o2 ? o1.id === o2.id : o1 === o2;
  }

  filterTargetOrganisation() {

    let criteria = new SearchObject<OrganisationSearchCriteria>();
    criteria.criteria = {
      name: this.clientRequestSignal().organisationFilter || ''
    }
    this.organisationApi.search(criteria).subscribe({
      next: (result) => {
        this.targetOrganisationBackingList = result || [];
        this.targetOrganisationFilteredList.set(this.targetOrganisationBackingList);
      }
    })  ;
  }

  targetOrganisationBackingList: OrganisationListDTO[] = [];
  targetOrganisationFilteredList = linkedSignal<OrganisationListDTO[]>(() => []);

  individualCompare(o1: IndividualListDTO | any, o2: IndividualListDTO | any) {
    return o1 && o2 ? o1.id === o2.id : o1 === o2;
  }

  filterTargetIndividual() {

    let criteria: SearchObject<IndividualSearchCriteria> = new SearchObject<IndividualSearchCriteria>();
    criteria.criteria = new IndividualSearchCriteria();
    criteria.criteria.surname = this.clientRequestSignal().targetIdFilter || '';

    this.individualApiStore.search({ criteria });
  }

  targetIndividualBackingList: IndividualListDTO[] = [];
  targetIndividualFilteredList = linkedSignal<IndividualListDTO[]>(() => this.individualApiStore.dataList());

  ClientRequestStatusT: any = ClientRequestStatus;
  ClientRequestStatusOptions = Object.keys(this.ClientRequestStatusT);
  TargetEntityT: any = TargetEntity;
  // Only allow ORGANISATION and INDIVIDUAL
  TargetEntityOptions = [TargetEntity.ORGANISATION, TargetEntity.INDIVIDUAL];

  loaderMessage = this.clientRequestApiStore.loaderMessage;
  messages = this.clientRequestApiStore.messages;
  success = this.clientRequestApiStore.success;
  loading = this.clientRequestApiStore.loading;
  error = this.clientRequestApiStore.error;
  selected: any = null;

  constructor() {
    effect(() => {
      let messages = this.messages();

      if (this.success() && !this.loading()) {
        this.toaster.success(messages[0]);
      }

      if (this.error() && !this.loading()) {
        this.toaster.error(messages[0]);
      }
    });
  }

  ngOnInit() {
  }

  formReset() {
    this.clientRequestSignal.set(new ClientRequestSearchForm());
  }

  ngAfterViewInit() {
    this.clientRequestController.resetUseCaseScope();
    this.clientRequestsTable?.tablePaginator?.page?.subscribe({
      next: (paginator: any) => {
        this.searchClientRequests(paginator.pageIndex, paginator.pageSize);
      },
    });
  }

  ngOnDestroy() {
  }

  get searchCriteria(): ClientRequestSearchCriteria {
    const criteria = new ClientRequestSearchCriteria();
    const formValue = this.clientRequestSignal();

    criteria.name = formValue.name;
    criteria.emailAddress = formValue.emailAddress;
    // criteria.registration = formValue.registration;
    criteria.organisation = formValue.organisation?.name || null;
    criteria.organisationId = formValue.organisation?.id;
    criteria.target = (formValue.target || "") ? formValue.target : null;
    criteria.targetId = formValue.targetId?.id || null;

    if (formValue.status) {
      criteria.statuses = [formValue.status];
    }

    return criteria;
  }

  searchClientRequests(pageNumber = 0, pageSize = 10): void {

    let searchObject = new SearchObject<ClientRequestSearchCriteria>();
    searchObject.criteria = this.searchCriteria;
    searchObject.pageNumber = pageNumber;
    searchObject.pageSize = pageSize;

    this.clientRequestApiStore.pagedSearch({
      criteria: searchObject,
    });
  }

  beforeAddNewClientRequest(form: any): void { }
  afterAddNewClientRequest(form: any): void { }

  addNewClientRequest(): void {
    let form: any = {};

    this.beforeAddNewClientRequest(form);
    // Navigate to add new client request
    // this.clientRequestController.addNewClientRequest();
    this.afterAddNewClientRequest(form);
  }

}
