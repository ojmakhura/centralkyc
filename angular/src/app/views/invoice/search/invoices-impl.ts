// Generated by andromda-angular cartridge (view\view.component.imp.ts.vsl) CAN EDIT!
import { Component, inject, linkedSignal } from '@angular/core';
import { InvoicesComponent } from '@views/invoice/search/invoices';
import { CommonModule, CurrencyPipe, DatePipe } from '@angular/common';
import { FormsModule, ReactiveFormsModule } from '@angular/forms';
import { TranslateModule } from '@ngx-translate/core';
import { MaterialModule } from '@app/material.module';
import { TableComponent } from '@components/table/table';
import { Loader } from "@shared/loader/loader";
import { FormField } from '@angular/forms/signals';
import { InvoiceSearchCriteria } from '@app/models/bw/co/centralkyc/invoice/invoice-search-criteria';
import { SearchObject } from '@app/models/search-object';
import { ColumnModel } from '@app/models/column.model';

@Component({
  selector: 'app-invoices',
  templateUrl: './invoices.html',
  styleUrls: ['./invoices.scss'],
  standalone: true,
  imports: [
    CommonModule,
    FormsModule,
    ReactiveFormsModule,
    TranslateModule,
    MaterialModule,
    TableComponent,
    Loader,
    FormField,
  ],
  providers: [
    CurrencyPipe,
    DatePipe
  ],
})
export class InvoicesImplComponent extends InvoicesComponent {

  datePipe = inject(DatePipe);
  currencyPipe = inject(CurrencyPipe);
  override error = linkedSignal(() => this.kycInvoiceApiStore.error());
  override messages = linkedSignal(() => this.kycInvoiceApiStore.messages());
  override success = linkedSignal(() => this.kycInvoiceApiStore.success());
  override loading = linkedSignal(() => this.kycInvoiceApiStore.loading());

  override invoicesTableSignal = linkedSignal(() => this.kycInvoiceApiStore.dataPage());
  override invoicesTableColumns: ColumnModel[] = [
    new ColumnModel(
      'ref',
      'ref',
      false,
    ),
    new ColumnModel(
      'organisationName',
      'organisation.name',
      false,
    ),
    new ColumnModel(
      'startDate',
      'start.date',
      false,
      undefined,
      this.datePipe,
      ['dd-MM-yyyy']
    ),
    new ColumnModel(
      'endDate',
      'end.date',
      false,
      undefined,
      this.datePipe,
      ['dd-MM-yyyy']
    ),
    new ColumnModel(
      'amount',
      'amount',
      false,
      undefined,
      this.currencyPipe,
      ['BWP']
    ),
  ];

  constructor() {
    super();
  }

  doNgOnDestroy(): void {
  }

  override beforeInvoicesSearch(form: any): void {
      this.doSearch();
    }

    private doSearch(pageNumber: number = 0, pageSize: number = 10): void {
      let value = this.invoicesSignal();

      let criteria = new SearchObject<InvoiceSearchCriteria>()
      criteria.pageNumber = pageNumber;
      criteria.pageSize = pageSize;
      criteria.criteria = {
        organisatonId: value.organisation?.id,
        ref: value.ref,
        paid: value.paid,
      };

      this.kycInvoiceApiStore.pagedSearch({
        criteria: criteria
      });
    }
}
