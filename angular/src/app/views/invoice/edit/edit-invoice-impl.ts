// Generated by andromda-angular cartridge (view\view.component.imp.ts.vsl) CAN EDIT!
import { Component, computed, effect, inject, linkedSignal } from '@angular/core';
import { EditInvoiceComponent } from '@views/invoice/edit/edit-invoice';
import { EditInvoiceVarsForm } from '@views/invoice/edit/edit-invoice';
import { MatRadioChange } from '@angular/material/radio';
import { MatCheckboxChange } from '@angular/material/checkbox';
import { CommonModule } from '@angular/common';
import { FormsModule, ReactiveFormsModule } from '@angular/forms';
import { TranslateModule } from '@ngx-translate/core';
import { MaterialModule } from '@app/material.module';
import { TableComponent } from '@components/table/table';
import { Loader } from "@shared/loader/loader";
import { Field } from '@angular/forms/signals';
import { OrganisationApiStore } from '@app/store/bw/co/centralkyc/organisation/organisation-api.store';
import { OrganisationListDTO } from '@app/models/bw/co/centralkyc/organisation/organisation-list-dto';

@Component({
  selector: 'app-edit-invoice',
  templateUrl: './edit-invoice.html',
  styleUrls: ['./edit-invoice.scss'],
  standalone: true,
  imports: [
    CommonModule,
    FormsModule,
    ReactiveFormsModule,
    TranslateModule,
    MaterialModule,
    TableComponent,
    Loader,
    Field,
  ],
})
export class EditInvoiceImplComponent extends EditInvoiceComponent {

  organisationApiStore = inject(OrganisationApiStore);

  override loading = computed(
    () => this.kycInvoiceApiStore.loading()
  );

  override organisationFilteredList = linkedSignal(() => this.organisationApiStore.dataList());

  override error = linkedSignal(() => this.kycInvoiceApiStore.error());
  override messages = linkedSignal(() => this.kycInvoiceApiStore.messages());
  override success = linkedSignal(() => this.kycInvoiceApiStore.success());

  invoice = this.kycInvoiceApiStore.data;

  override organisationDisplays: string[] = ['name'];

  constructor() {
    super();

    effect(() => {
      const invoice = this.kycInvoiceApiStore.data();

      if (!invoice) {
        return;
      }

      console.log('Invoice loaded in edit component:', invoice);
      // this.editInvoiceForm.patchValue(invoice);

      this.editInvoiceSignal.update((form) => ({
        ...form,
        id: invoice.id,
        createdAt: invoice.createdAt,
        createdBy: invoice.createdBy,
        modifiedAt: invoice.modifiedAt,
        modifiedBy: invoice.modifiedBy,
        organisation: invoice.organisationId ? {
          id: invoice.organisationId,
          name: invoice.organisationName,
          code: invoice.organisatonCode,
          registrationNo: invoice.organisationRegistrationNo,
          status: '',
          contactEmailAddress: ''
        } : null,
        ref: invoice.ref,
        subscriptionPeriod: invoice.subscriptionPeriod,
        startDate: invoice.startDate,
        endDate: invoice.endDate,
        amount: invoice.amount,
        paid: invoice.paid,
        paymentDate: invoice.paymentDate,
        paymentReference: invoice.paymentReference,

      }));

      if (invoice.organisationId) {

        this.organisationFilteredList.set([{
          id: invoice.organisationId,
          name: invoice.organisationName,
          code: invoice.organisatonCode,
          registrationNo: invoice.organisationRegistrationNo,
          status: '',
          contactEmailAddress: '',
          isClient: false,
          kycStatus: ''
        }]);

      }
    });
  }

  override ngOnInit() {
    this.kycInvoiceApiStore.reset();

    this.route.queryParams.subscribe((params: any) => {
      if (params.id) {
        this.kycInvoiceApiStore.findById(params);
      }
    });
  }

  doNgOnDestroy(): void { }

  override organisationCompare(o1: OrganisationListDTO | any, o2: OrganisationListDTO | any) {
    return o1 && o2 ? o1.id === o2.id : false;
  }
}
