// Generated by andromda-angular cartridge (view\view.component.imp.ts.vsl) CAN EDIT!
import { Component, effect, inject, signal, linkedSignal, ViewChild, WritableSignal } from '@angular/core';
import { OrganisationDetailsComponent } from '@app/views/organisation/details/organisation-details';
import { OrganisationDetailsVarsForm } from '@app/views/organisation/details/organisation-details';
import { MatRadioChange } from '@angular/material/radio';
import { MatCheckboxChange } from '@angular/material/checkbox';
import { CommonModule, CurrencyPipe, DatePipe } from '@angular/common';
import { FormsModule, ReactiveFormsModule } from '@angular/forms';
import { TranslateModule } from '@ngx-translate/core';
import { MaterialModule } from '@app/material.module';
import { BranchDTO } from '@models/bw/co/centralkyc/organisation/branch/branch-dto';
import { MatDialog, MatDialogConfig } from '@angular/material/dialog';
import { MatPaginator, PageEvent } from '@angular/material/paginator';
import { Router } from '@angular/router';
import { TableComponent } from '@app/components/table/table';
import { Loader } from '@app/@shared/loader/loader';
import { BranchApi } from '@app/services/bw/co/centralkyc/organisation/branch/branch-api';
import { ClientRequestApi } from '@app/services/bw/co/centralkyc/organisation/client/client-request-api';
import { ClientRequestDTO } from '@app/models/bw/co/centralkyc/organisation/client/client-request-dto';
import { ColumnModel } from '@app/models/column.model';
import { OrganisationDTO } from '@app/models/bw/co/centralkyc/organisation/organisation-dto';
import { Page } from '@app/models/page.model';
import { DialogComponent } from '@app/components/dialog/dialog';
import { BranchEditorImplComponent } from '@app/components/organisation/branch/branch-editor-impl';
import { ActionTemplate } from '@app/models/action-template';
import { KycSubscriptionDTO } from '@app/models/bw/co/centralkyc/subscription/kyc-subscription-dto';
import { KycInvoiceDTO } from '@app/models/bw/co/centralkyc/invoice/kyc-invoice-dto';
import { Field } from '@angular/forms/signals';
import { PhoneNumber } from '@app/models/bw/co/centralkyc/phone-number';
import { OrganisationDomain } from '@app/models/bw/co/centralkyc/organisation/organisation-domain';
import { BranchApiStore } from '@app/store/bw/co/centralkyc/organisation/branch/branch-api.store';
import { KycInvoiceApiStore } from '@app/store/bw/co/centralkyc/invoice/kyc-invoice-api.store';
import { KycSubscriptionApiStore } from '@app/store/bw/co/centralkyc/subscription/kyc-subscription-api.store';
import { ClientRequestApiStore } from '@app/store/bw/co/centralkyc/organisation/client/client-request-api.store';
import { BranchEditorForm } from '@app/components/organisation/branch/branch-editor';
import { TargetEntity } from '@app/models/bw/co/centralkyc/target-entity';
import { ClientRequestStatus } from '@app/models/bw/co/centralkyc/organisation/client/client-request-status';

@Component({
  selector: 'app-organisation-details',
  templateUrl: './organisation-details.html',
  styleUrls: ['./organisation-details.scss'],
  standalone: true,
  imports: [
    CommonModule,
    FormsModule,
    ReactiveFormsModule,
    TranslateModule,
    MaterialModule,
    TableComponent,
    Loader,
    Field
  ],
  providers: [DatePipe, CurrencyPipe],
})
export class OrganisationDetailsImplComponent extends OrganisationDetailsComponent {
  // organisationApiStore = inject(OrganisationApiStore);
  branchApiStore = inject(BranchApiStore);
  branchApi = inject(BranchApi);
  kycInvoiceApiStore = inject(KycInvoiceApiStore);
  kycSubscriptionApiStore = inject(KycSubscriptionApiStore);
  clientRequestApiStore = inject(ClientRequestApiStore);
  clientRequestApi = inject(ClientRequestApi);
  datePipe = inject(DatePipe);
  currencyPipe = inject(CurrencyPipe);

  override error = linkedSignal(() => false);
  override loaderMessage = linkedSignal(() => 'Loading...');
  override messages = linkedSignal(() => false);
  override success = linkedSignal(() => false);
  override loading = linkedSignal(() => this.organisationApiStore.loading() || this.clientRequestApiStore.loading());
  organisation = linkedSignal(() => this.organisationApiStore.data());

  // Branches related properties
  branches = linkedSignal<BranchDTO[]>(() => this.branchApiStore.dataList());
  branchesLoading = linkedSignal(() => false);
  currentPage = signal(0);
  pageSize = signal(10);
  totalBranches = signal(0);

  // Invoices related properties
  invoices = this.kycInvoiceApiStore.dataList;
  invoicesLoading = linkedSignal(() => false);

  // Subscriptions related properties
  subscriptions = linkedSignal<KycSubscriptionDTO[]>(() => this.kycSubscriptionApiStore.dataList());
  subscriptionsLoading = linkedSignal(() => false);

  override clientRequestsTableSignal = linkedSignal<Page<ClientRequestDTO>>(() => this.clientRequestApiStore.dataPage());
  clientRequests = linkedSignal<ClientRequestDTO[]>(() => this.clientRequestsTableSignal().content || []);
  clientRequestStatuses = Object.values(ClientRequestStatus);
  clientRequestsColumns = [
    'createdAt', 'organisation', 'status'
  ]

  // Individual Client Requests related properties
  individualClientRequests = linkedSignal(() => this.clientRequestApiStore.individualsRequestsPage());
  @ViewChild('individualClientRequestsTable') individualClientRequestsTable!: TableComponent<ClientRequestDTO>;
  individualClientRequestsLoading = linkedSignal(() => false);
  uploadedIndividualClientRequestFiles = signal<any[]>([]);
  isUploadingIndividualClientRequestFile = signal(false);
  individualClientRequestFileUploadProgress = signal(0);

  // Organisation Client Requests related properties
  organisationClientRequests = this.clientRequestApiStore.organisationsRequestsPage;
  @ViewChild('organisationClientRequestsTable') organisationClientRequestsTable!: TableComponent<ClientRequestDTO>;
  organisationClientRequestsLoading = linkedSignal(() => false);
  uploadedOrganisationClientRequestFiles = signal<any[]>([]);
  isUploadingOrganisationClientRequestFile = signal(false);
  organisationClientRequestFileUploadProgress = signal(0);

  requestsColumns = [...this.clientRequestsTableColumns.map(column => column.id), 'actions'];

  constructor() {
    super();

    // Effect to load branches when organisation is loaded
    effect(() => {
      const org = this.organisation();
      if (org?.id) {
        this.loadBranches();
        this.loadInvoices();
        this.loadSubscriptions();
        this.loadIndividualClientRequests();
        this.loadOrganisationClientRequests();
        this.doSearchRequests();
      }
    });

    // Effect to update total branches count
    effect(() => {
      const branchList = this.branches();
      if (branchList) {
        this.totalBranches.set(branchList.length);
      }
    });

    effect(() => {
      let page = this.clientRequestApiStore.dataPage();
      console.log('Client Requests Page updated:', page);
    });

  }

  individualClientRequestsTableColumns: ColumnModel[] = [
    new ColumnModel(
      'registration',
      'identity.no',
      false,
    ),
    new ColumnModel(
      'name',
      'name',
      false,
    ),
    new ColumnModel(
      'status',
      'status',
      false,
    ),
  ];

  @ViewChild('individualClientRequestsTable') set individualClientRequestsTableComp(individualClientRequestsTable: TableComponent<ClientRequestDTO> | undefined) {
    if (individualClientRequestsTable) {
      // Do something when child is created
      this.individualClientRequestsTable?.tablePaginator?.page?.subscribe({
        next: (paginator: MatPaginator) => {
          console.log('Paginator event:', paginator);
          this.clientRequestApiStore.findIndividualsByOrganisationPaged({
            organisationId: this.organisation().id,
            pageNumber: paginator.pageIndex,
            pageSize: paginator.pageSize
          });
        },
      });
    }
  }

  @ViewChild('organisationClientRequestsTable') set organisationClientRequestsTableComp(organisationClientRequestsTable: TableComponent<ClientRequestDTO> | undefined) {
    if (organisationClientRequestsTable) {
      // Do something when child is created
      this.organisationClientRequestsTable?.tablePaginator?.page?.subscribe({
        next: (paginator: MatPaginator) => {
          console.log('Paginator event:', paginator);
          this.clientRequestApiStore.findOrganisationsByOrganisationPaged({
            organisationId: this.organisation().id,
            pageNumber: paginator.pageIndex,
            pageSize: paginator.pageSize
          });
        },
      });
    }
  }

  override ngOnInit() {
    this.organisationApiStore.reset();
    this.branchApiStore.reset();
    this.kycInvoiceApiStore.reset();
    this.kycSubscriptionApiStore.reset();
    this.clientRequestApiStore.reset();

    this.route.queryParams.subscribe((params: any) => {
      if (params.id) {
        this.organisationApiStore.findById(params);
      }
    });
  }

  override doNgAfterViewInit(): void {

  }

  private doSearchRequests(pageNumber: number = 0, pageSize: number = 10, target?: TargetEntity): void {
    let org = this.organisation();
    if (org?.id) {
      this.clientRequestApiStore.findByTargetPaged({
        target: TargetEntity.ORGANISATION,
        targetId: org.id,
        pageNumber,
        pageSize,
      });
    }
  }

  // Branches Management Methods
  loadBranches(): void {
    const org = this.organisation();
    if (org?.id) {
      this.branchApiStore.findByOrganisation({ organisationId: org.id });
    }
  }

  refreshBranches(): void {
    this.loadBranches();
  }

  // Invoices Management Methods
  loadInvoices(): void {
    const org = this.organisation();
    if (org?.id) {
      this.kycInvoiceApiStore.findByOrganisation({ organisationId: org.id });
    }
  }

  refreshInvoices(): void {
    this.loadInvoices();
  }

  // Subscriptions Management Methods
  loadSubscriptions(): void {
    const org = this.organisation();
    if (org?.id) {
      this.kycSubscriptionApiStore.findByOrganisation({ organisationId: org.id });
    }
  }

  refreshSubscriptions(): void {
    this.loadSubscriptions();
  }

  doEditBranch(branch: BranchDTO): void {

    console.log(branch);

    let branchEditorForm = new BranchEditorForm();
    branchEditorForm.id = branch.id;
    branchEditorForm.organisationId = branch.organisationId;
    branchEditorForm.organisation = branch.organisation;
    branchEditorForm.code = branch.code;
    branchEditorForm.name = branch.name;
    branchEditorForm.description = branch.description;
    branchEditorForm.physicalAddress = branch.physicalAddress;
    branchEditorForm.createdBy = branch.createdBy;
    branchEditorForm.createdAt = branch.createdAt;
    branchEditorForm.modifiedBy = branch.modifiedBy;
    branchEditorForm.modifiedAt = branch.modifiedAt;

    const dialogRef = this.dialog.open(DialogComponent<BranchEditorForm, BranchEditorImplComponent>, <MatDialogConfig>{
      hasBackdrop: true,
      closeOnNavigation: true,
      disableClose: true,
      width: '800px',
      data: {
        component: BranchEditorImplComponent,
        title: 'Edit Section',
        inputs: {
          formData: branchEditorForm,
        },
        actions: [
          {
            id: 'save',
            label: 'Save',
            icon: 'save',
            tooltip: 'Save Section',
          },
        ],
      },
    });

    dialogRef.afterClosed().subscribe({
      next: (data) => {
        console.log('Dialog closed with data:', data);
        if (data?.action === 'save') {
          this.branchApi.save(data.value).subscribe({
            next: (field) => {
              // this.toastr.success('Field saved successfully');
              this.loadBranches();
            },
            error: (err) => {
              console.error('Error saving field:', err);
              // this.toastr.error('Error saving field');
            },
          });
        }
      },
    });
  }

  addNewBranch(): void {
    let branch = new BranchDTO();
    const org = this.organisation();
    branch.organisationId = org.id;
    branch.organisation = org.name;

    this.doEditBranch(branch);
  }

  deleteBranch(branchId: string): void {
    if (confirm('Are you sure you want to delete this branch?')) {
      // this.branchApiStore.remove({ id: branchId });
      // Reload branches after deletion
      setTimeout(() => {
        this.loadBranches();
      }, 1000);
    }
  }

  onPageChange(event: PageEvent): void {
    this.currentPage.set(event.pageIndex);
    this.pageSize.set(event.pageSize);
    // Here you would typically load the specific page of branches
    // For now, we'll just update the pagination state
  }

  doNgOnDestroy(): void { }

  branchTablePaged = signal(false);

  override branchesTableColumnsActions: ActionTemplate[] = [
    {
      id: 'branch-edit',
      label: 'edit',
      icon: 'edit',
      tooltip: 'edit',
    },
    {
      id: 'branch-delete',
      label: 'delete',
      icon: 'delete',
      tooltip: 'delete',
    },
  ];

  branchesTableActionClicked(event: any): void {
    console.log(event);

    switch (event.action) {
      case 'branch-edit':
        // TODO: Implement the action
        this.doEditBranch(event.row);
        break;
      case 'branch-delete':
        // TODO: Implement the action
        this.deleteBranch(event.id);
        break;
    }
  }

  // Invoices Table Configuration
  invoicesTablePaged = signal(false);
  invoicesTableColumns: ColumnModel[] = [
    new ColumnModel('ref', 'ref', false),
    new ColumnModel('amount', 'amount', false, undefined, this.currencyPipe, ['BWP']),
    new ColumnModel('paid', 'paid', false),
    new ColumnModel('paymentReference', 'payment.reference', false),
  ];

  invoicesTableColumnsActions: ActionTemplate[] = [
    {
      id: 'invoice-view',
      label: 'view',
      icon: 'visibility',
      tooltip: 'view',
    },
  ];

  invoicesTableActionClicked(event: any): void {
    console.log(event);

    switch (event.action) {
      case 'invoice-view':
        this.router.navigate(['/invoice/details'], { queryParams: { id: event.row.id } });
        break;
    }
  }

  // Subscriptions Table Configuration
  subscriptionsTablePaged = signal(false);
  subscriptionsTableColumns: ColumnModel[] = [
    new ColumnModel('ref', 'ref', false),
    new ColumnModel('period', 'period', false),
    new ColumnModel('amount', 'amount', false, undefined, this.currencyPipe, ['BWP']),
    new ColumnModel('startDate', 'start.date', false, undefined, this.datePipe, ['dd/MM/yyyy']),
    new ColumnModel('endDate', 'end.date', false, undefined, this.datePipe, ['dd/MM/yyyy']),
    new ColumnModel('status', 'status', false),
  ];

  subscriptionsTableColumnsActions: ActionTemplate[] = [
    {
      id: 'subscription-view',
      label: 'view',
      icon: 'visibility',
      tooltip: 'view',
    },
  ];

  subscriptionsTableActionClicked(event: any): void {
    console.log(event);

    switch (event.action) {
      case 'subscription-view':
        this.router.navigate(['/subscription/details'], { queryParams: { id: event.row.id } });
        break;
    }
  }

  // Client Requests Management Methods
  loadIndividualClientRequests(pageNumber: number = 0, pageSize: number = 10): void {

    const org = this.organisation();
    if (org?.id) {
      this.clientRequestApiStore.findIndividualsByOrganisationPaged({
        organisationId: org.id,
        pageNumber,
        pageSize
      });
    }
  }

  loadOrganisationClientRequests(pageNumber: number = 0, pageSize: number = 10): void {
    const org = this.organisation();
    if (org?.id) {
      this.clientRequestApiStore.findOrganisationsByOrganisationPaged({
        organisationId: org.id,
        pageNumber,
        pageSize
      });
    }
  }

  refreshClientRequests(): void {
    this.doSearchRequests();
  }

  loadClientRequests(pageNumber: number = 0, pageSize: number = 10): void {
    this.doSearchRequests(pageNumber, pageSize);
  }

  addNewClientRequest(target: TargetEntity): void {
    this.router.navigate(['/client-request/edit'], {
      queryParams: { organisationId: this.organisation().id, target: target },
    });
  }

  // Individual Client Requests Management Methods
  refreshIndividualClientRequests(): void {
    this.loadIndividualClientRequests();

  }

  // addNewIndividualClientRequest(): void {
  //   this.router.navigate(['/client-request/edit'], {
  //     queryParams: {
  //       organisationId: this.organisation().id,
  //       target: TargetEntity.INDIVIDUAL
  //     },
  //   });
  // }

  onIndividualClientRequestFileSelected(event: any): void {
    const files: FileList = event.target.files;
    if (files && files.length > 0) {
      this.isUploadingIndividualClientRequestFile.set(true);
      this.individualClientRequestFileUploadProgress.set(0);

      // Simulate file upload progress
      const interval = setInterval(() => {
        const currentProgress = this.individualClientRequestFileUploadProgress();
        if (currentProgress < 100) {
          this.individualClientRequestFileUploadProgress.set(currentProgress + 10);
        } else {
          clearInterval(interval);

          const newFiles = Array.from(files).map((file, index) => ({
            id: `file-${Date.now()}-${index}`,
            fileName: file.name,
            fileSize: file.size,
            file: file,
          }));

          this.uploadedIndividualClientRequestFiles.set([...this.uploadedIndividualClientRequestFiles(), ...newFiles]);
          this.isUploadingIndividualClientRequestFile.set(false);
          this.individualClientRequestFileUploadProgress.set(0);
          event.target.value = '';
        }
      }, 300);

      // TODO: Implement actual file upload with targetEntity=INDIVIDUAL
      this.clientRequestApiStore.uploadRequests({
        file: files[0],
        organisationId: this.organisation().id,
        target: TargetEntity.INDIVIDUAL
      });
    }
  }

  // Organisation Client Requests Management Methods
  refreshOrganisationClientRequests(): void {
    this.loadOrganisationClientRequests();
  }

  // addNewOrganisationClientRequest(): void {
  //   this.router.navigate(['/client-request/edit'], {
  //     queryParams: {
  //       organisationId: this.organisation().id,
  //       target: TargetEntity.ORGANISATION
  //     },
  //   });
  // }

  downloadOrganisationRequestTemplate(): void {
    // TODO: Implement download template for organisation requests
    console.log('Download organisation request template');
  }

  onOrganisationClientRequestFileSelected(event: any): void {
    const files: FileList = event.target.files;
    if (files && files.length > 0) {
      this.isUploadingOrganisationClientRequestFile.set(true);
      this.organisationClientRequestFileUploadProgress.set(0);

      // Simulate file upload progress
      const interval = setInterval(() => {
        const currentProgress = this.organisationClientRequestFileUploadProgress();
        if (currentProgress < 100) {
          this.organisationClientRequestFileUploadProgress.set(currentProgress + 10);
        } else {
          clearInterval(interval);

          const newFiles = Array.from(files).map((file, index) => ({
            id: `file-${Date.now()}-${index}`,
            fileName: file.name,
            fileSize: file.size,
            file: file,
          }));

          this.uploadedOrganisationClientRequestFiles.set([...this.uploadedOrganisationClientRequestFiles(), ...newFiles]);
          this.isUploadingOrganisationClientRequestFile.set(false);
          this.organisationClientRequestFileUploadProgress.set(0);
          event.target.value = '';
        }
      }, 300);

      // TODO: Implement actual file upload with targetEntity=ORGANISATION
      this.clientRequestApiStore.uploadRequests({
        file: files[0],
        organisationId: this.organisation().id,
        target: TargetEntity.ORGANISATION
      });
    }
  }

  override clientRequestsTableActionClicked(event: any): void {
    console.log(event);

    switch (event.action) {
      case 'client-request-view':
        this.router.navigate(['/client-request/details'], { queryParams: { id: event.row.id } });
        break;
      case 'client-request-edit':
        this.router.navigate(['/client-request/edit'], { queryParams: { id: event.row.id } });
        break;
    }
  }

  downloadIndividualRequestTemplate(): void {
    // TODO: Optionally fetch template from server if backend provides a specific format
    this.clientRequestApi.downloadRequestTemplate().subscribe({
      next: (blob: Blob) => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'individual_client_requests_template.xlsx';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      },
      error: (err) => {
        console.error('Error downloading template:', err);
      },
    });
  }

  override organisationDetailsEdit(): void {
    this.router.navigate(['/organisation/edit'], { queryParams: { id: this.organisation().id } });
  }

  onClientRequestStatusChange(clientRequest: ClientRequestDTO, newStatus: ClientRequestStatus): void {

    console.log('Changing status of Client Request ID:', clientRequest.id, 'to', newStatus);

    this.clientRequestApiStore.updateStatus({
      id: clientRequest.id,
      status: newStatus
    });
  }

  onClientRequestsPageChange(event: any): void {
    // this.clientRequestsPageIndex.set(event.pageIndex);
    // this.clientRequestsPageSize.set(event.pageSize);
    // const individual = this.individual();
    // if (individual?.id) {
    //   this.loadClientRequests(individual.id);
    // }
  }
}
